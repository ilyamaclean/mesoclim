<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="mesoclim">
<title>3. Spatial downscaling â€¢ mesoclim</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="3. Spatial downscaling">
<meta property="og:description" content="mesoclim">
<meta property="og:image" content="https://jrmosedale.github.io/mesoclim/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mesoclim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/mesoclim_1_download.html">1 Downloading Inputs</a>
    <a class="dropdown-item" href="../articles/mesoclim_2_preparedata.html">2. Data pre-processing</a>
    <a class="dropdown-item" href="../articles/mesoclim_3_spdscale.html">3. Spatial downscaling</a>
    <a class="dropdown-item" href="../articles/mesoclim_4_tmpdscale.html">4. Temporal downscaling</a>
    <a class="dropdown-item" href="../articles/mesoclim_5_biascorrect.html">5. Bias correction</a>
    <a class="dropdown-item" href="../articles/mesoclim_addtrees.html">ADDTREES Workflow without bias correction</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>3. Spatial downscaling</h1>
            
      
      <small class="dont-index">Source: <a href="NA/NA/NA/blob/HEAD/vignettes/articles/mesoclim_3_spdscale.Rmd"><code>vignettes/articles/mesoclim_3_spdscale.Rmd</code></a></small>
      <div class="d-none name"><code>mesoclim_3_spdscale.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="spatial-downscaling-of-ukcp18-regional-climate-data">3. Spatial Downscaling of UKCP18 regional climate data<a class="anchor" aria-label="anchor" href="#spatial-downscaling-of-ukcp18-regional-climate-data"></a>
</h2>
<div class="section level3">
<h3 id="defining-the-area-of-interest">Defining the area of interest<a class="anchor" aria-label="anchor" href="#defining-the-area-of-interest"></a>
</h3>
<p>The projection, resolution and extent of the downscaled area is
defined by providing a fine-resolution DTM that also acts as a land/sea
mask with sea cells having a NA value.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get fine and medium res DTMs from package</span></span>
<span><span class="va">dir_dtm</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata/dtms'</span>,package<span class="op">=</span><span class="st">'mesoclim'</span><span class="op">)</span></span>
<span><span class="va">dtmm</span><span class="op">&lt;-</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir_dtm</span>,<span class="st">'dtmm.tif'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dtmf</span><span class="op">&lt;-</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir_dtm</span>,<span class="st">'dtmf.tif'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show local downscale area within wider dtmm</span></span>
<span><span class="va">aoi</span><span class="op">&lt;-</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">dtmf</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/frame.html" class="external-link">plot.new</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dtmm</span>,main<span class="op">=</span><span class="st">'Downscale area within wider dtmm'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">aoi</span>,add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesoclim_3_spdscale_files/figure-html/downscaled-dtm-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="preparing-the-data">Preparing the data<a class="anchor" aria-label="anchor" href="#preparing-the-data"></a>
</h3>
<p>Coarse resolution climate and ancillary data will need to be prepared
as outlined in
<code><a href="../articles/mesoclim_2_preparedata.html">vignette('mesoclim_2_preparedata', package='mesoclim')</a></code>.</p>
<p>Sea surface temperature data must also be prepared for the
surrounding area and for the same time period as the input climate
data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load prepared climate data</span></span>
<span><span class="va">ukcp18rcm</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/read_climdata.html">read_climdata</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata/preprepdata'</span>,package<span class="op">=</span><span class="st">'mesoclim'</span><span class="op">)</span>,<span class="st">'ukcp18rcm.Rds'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get time period </span></span>
<span><span class="va">startdate</span><span class="op">&lt;-</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tme</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">enddate</span><span class="op">&lt;-</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tme</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tme</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># set model run as same as that in climate data </span></span>
<span><span class="va">member</span><span class="op">&lt;-</span><span class="st">'01'</span></span>
<span></span>
<span><span class="co"># Load sea surface data </span></span>
<span><span class="va">dir_sst</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata/ukcp18sst'</span>,package<span class="op">=</span><span class="st">'mesoclim'</span><span class="op">)</span></span>
<span><span class="va">sst</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/create_ukcpsst_data.html">create_ukcpsst_data</a></span><span class="op">(</span><span class="va">dir_sst</span>,<span class="va">startdate</span>,<span class="va">enddate</span>,<span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">dtm</span>,<span class="va">member</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="single-step-downscaling">Single step downscaling<a class="anchor" aria-label="anchor" href="#single-step-downscaling"></a>
</h3>
<p>Wrapper function allows downscaling in a single function call, with
parameters defining which processes are captured by the downscaling.</p>
<div class="section level4">
<h4 id="improvements">Improvements<a class="anchor" aria-label="anchor" href="#improvements"></a>
</h4>
<ul>
<li><p>Include dtmf in <code>spatialdownscale</code> output.</p></li>
<li><p>Allow <code>spatialdownscale</code> output as spatrasters,
packedspatrasters or arrays.</p></li>
<li><p>Include wind and temp height in <code>spatialdownscale</code>
output</p></li>
<li><p>Write climdata to file function that converts to packed rast or
arrays?</p></li>
<li><p>Read climdata file function?</p></li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Downscale one year of future climate data</span></span>
<span></span>
<span><span class="va">t0</span><span class="op">&lt;-</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/now.html" class="external-link">now</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">mesoclimate</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/spatialdownscale.html">spatialdownscale</a></span><span class="op">(</span><span class="va">ukcp18rcm</span>, <span class="va">sst</span>, <span class="va">dtmf</span>, <span class="va">dtmm</span>, basins <span class="op">=</span> <span class="cn">NA</span>, cad <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                           coastal <span class="op">=</span> <span class="cn">TRUE</span>, thgto <span class="op">=</span><span class="fl">2</span>, whgto<span class="op">=</span><span class="fl">2</span>, </span>
<span>                           rhmin <span class="op">=</span> <span class="fl">20</span>, pksealevel <span class="op">=</span> <span class="cn">TRUE</span>, patchsim <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                           terrainshade <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                           precipmethod <span class="op">=</span> <span class="st">"Elev"</span>, fast <span class="op">=</span> <span class="cn">TRUE</span>, noraincut <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="co">#&gt; Downscaling wind...</span></span>
<span><span class="co">#&gt; Downscaling temperature...</span></span>
<span><span class="co">#&gt; Downscaling relative humidity</span></span>
<span><span class="co">#&gt; Downscaling pressure...</span></span>
<span><span class="co">#&gt; Downscaling SW radiation...</span></span>
<span><span class="co">#&gt; Downscaling LW radiation with terrain shading...</span></span>
<span><span class="co">#&gt; Downscaling precipitation...</span></span>
<span><span class="co">#&gt; Formatting output...</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/now.html" class="external-link">now</a></span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="va">t0</span><span class="op">)</span></span>
<span><span class="co">#&gt; Time difference of 1.203168 mins</span></span>
<span></span>
<span><span class="co"># write_climdata(mesoclimate,file.path(system.file('extdata/dscaledata',package='mesoclim'),'mesoclimate.rds'))</span></span>
<span><span class="co"># mesoclimate&lt;-read_climdata(file.path(system.file('extdata/dscaledata',package='mesoclim'),'mesoclimate.rds')))</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="display-outputs">Display outputs<a class="anchor" aria-label="anchor" href="#display-outputs"></a>
</h4>
<p>In tabular form for all times and locations:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">climvars</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'tmin'</span>,<span class="st">'tmax'</span>,<span class="st">'relhum'</span>,<span class="st">'pres'</span>,<span class="st">'swrad'</span>,<span class="st">'lwrad'</span>,<span class="st">'windspeed'</span>,<span class="st">'winddir'</span>,<span class="st">'prec'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">smry_fun</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/coerce.html" class="external-link">as.array</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rslt</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">mesoclimate</span><span class="op">[</span><span class="va">climvars</span><span class="op">]</span>,<span class="va">smry_fun</span><span class="op">)</span></span>
<span><span class="va">stats_df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/transpose.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="va">rslt</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Min.'</span>,<span class="st">'Mean'</span>,<span class="st">'Max.'</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">stats_df</span><span class="op">)</span></span>
<span><span class="co">#&gt;              Min.    Mean    Max.</span></span>
<span><span class="co">#&gt; tmin        3.228   9.822  14.583</span></span>
<span><span class="co">#&gt; tmax        9.540  14.456  21.700</span></span>
<span><span class="co">#&gt; relhum     62.246  81.589  99.851</span></span>
<span><span class="co">#&gt; pres       94.888 100.654 103.322</span></span>
<span><span class="co">#&gt; swrad     105.524 217.810 348.668</span></span>
<span><span class="co">#&gt; lwrad     245.207 308.898 342.693</span></span>
<span><span class="co">#&gt; windspeed   0.043   2.786  12.406</span></span>
<span><span class="co">#&gt; winddir     0.003 183.142 359.998</span></span>
<span><span class="co">#&gt; prec        0.000   2.362  20.107</span></span></code></pre></div>
<p>Or as selected rasters for days corresponding to spatial quantiles
(eg days where spatial means are ata min, median and max values):</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span><span class="op">(</span><span class="va">var</span> <span class="kw">in</span> <span class="va">climvars</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span></span>
<span>  <span class="va">r</span><span class="op">&lt;-</span><span class="va">mesoclimate</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">var</span>,<span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/plot_q_layers.html">plot_q_layers</a></span><span class="op">(</span><span class="va">r</span>,vtext<span class="op">=</span><span class="va">var</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] "tmin"</span></span></code></pre></div>
<p><img src="mesoclim_3_spdscale_files/figure-html/map-outputs-1.png" width="700"></p>
<pre><code><span><span class="co">#&gt; [1] "tmax"</span></span></code></pre>
<p><img src="mesoclim_3_spdscale_files/figure-html/map-outputs-2.png" width="700"></p>
<pre><code><span><span class="co">#&gt; [1] "relhum"</span></span></code></pre>
<p><img src="mesoclim_3_spdscale_files/figure-html/map-outputs-3.png" width="700"></p>
<pre><code><span><span class="co">#&gt; [1] "pres"</span></span></code></pre>
<p><img src="mesoclim_3_spdscale_files/figure-html/map-outputs-4.png" width="700"></p>
<pre><code><span><span class="co">#&gt; [1] "swrad"</span></span></code></pre>
<p><img src="mesoclim_3_spdscale_files/figure-html/map-outputs-5.png" width="700"></p>
<pre><code><span><span class="co">#&gt; [1] "lwrad"</span></span></code></pre>
<p><img src="mesoclim_3_spdscale_files/figure-html/map-outputs-6.png" width="700"></p>
<pre><code><span><span class="co">#&gt; [1] "windspeed"</span></span></code></pre>
<p><img src="mesoclim_3_spdscale_files/figure-html/map-outputs-7.png" width="700"></p>
<pre><code><span><span class="co">#&gt; [1] "winddir"</span></span></code></pre>
<p><img src="mesoclim_3_spdscale_files/figure-html/map-outputs-8.png" width="700"></p>
<pre><code><span><span class="co">#&gt; [1] "prec"</span></span></code></pre>
<p><img src="mesoclim_3_spdscale_files/figure-html/map-outputs-9.png" width="700"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Show spatial range in daily temperatures</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">mesoclimate</span><span class="op">$</span><span class="va">tmax</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">mesoclimate</span><span class="op">$</span><span class="va">tmin</span><span class="op">)</span>,main<span class="op">=</span><span class="st">'Max diurnal temperature range'</span>, font.main <span class="op">=</span> <span class="fl">1</span>, nc<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesoclim_3_spdscale_files/figure-html/map-outputs-10.png" width="700"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,cex.main<span class="op">=</span><span class="fl">0.8</span>, mgp<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">0.1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/layout.html" class="external-link">layout</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">1</span>,<span class="fl">5</span>,<span class="fl">6</span>,<span class="fl">7</span>,<span class="fl">1</span>,<span class="fl">8</span>,<span class="fl">9</span>,<span class="fl">10</span><span class="op">)</span>,ncol<span class="op">=</span><span class="fl">3</span><span class="op">)</span>,heights<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#par(mfrow=c(3,3))</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/frame.html" class="external-link">plot.new</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/text.html" class="external-link">text</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="st">"Spatial mean (green), max (red) and min (blue) by day of year"</span>,cex<span class="op">=</span><span class="fl">1</span>,font<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">v</span> <span class="kw">in</span> <span class="va">climvars</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r</span><span class="op">&lt;-</span><span class="va">mesoclimate</span><span class="op">[[</span><span class="va">v</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="../reference/plot_timestats_r.html">plot_timestats_r</a></span><span class="op">(</span><span class="va">r</span>,<span class="va">v</span>,idx<span class="op">=</span><span class="st">'doy'</span>,lgd<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="mesoclim_3_spdscale_files/figure-html/tseries_output-1.png" width="700"></p>
</div>
</div>
<div class="section level3">
<h3 id="multiple-step-downscaling">Multiple step downscaling<a class="anchor" aria-label="anchor" href="#multiple-step-downscaling"></a>
</h3>
<p>Spatial downscaling can be decomposed to the effects of specific
physical processes, such as the effect of elevation, coastal or cold air
drainage on temperature. Specific functions for downscaling particular
effects can be applied without needing to undertake full downscaling
using all processes.</p>
<p><em>Note:</em> for individual functions, outputs may need further
processing to ensure names are times are carried through.</p>
<div class="section level4">
<h4 id="improvements-1">Improvements<a class="anchor" aria-label="anchor" href="#improvements-1"></a>
</h4>
<ul>
<li><p>Allow option of spatrast or array outputs? Or enforce a standard
spatrast output?</p></li>
<li><p>Allow passing standard data input list of climdata as well as
individual variables</p></li>
<li><p>Allow variable winddir in windspeed downscaling - or warning
message if input wind dir varies?</p></li>
</ul>
</div>
<div class="section level4">
<h4 id="pressure">Pressure<a class="anchor" aria-label="anchor" href="#pressure"></a>
</h4>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pres</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/presdownscale.html">presdownscale</a></span><span class="op">(</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">pres</span>, <span class="va">dtmf</span>, <span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">dtm</span>, sealevel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">pres</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'pres'</span>,<span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">pres</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">pres</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tme</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_q_layers.html">plot_q_layers</a></span><span class="op">(</span><span class="va">pres</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesoclim_3_spdscale_files/figure-html/pressure_dscale-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="cold-air-drainage">Cold air drainage<a class="anchor" aria-label="anchor" href="#cold-air-drainage"></a>
</h4>
<p>Requires the estimation of drainage basins defined by topography
which can be carried out separately from the estimation of cold-air
drainage in downscaling.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Basins - dtmf should have sea marked as NA</span></span>
<span><span class="va">basins</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/basindelin.html">basindelin</a></span><span class="op">(</span><span class="va">dtmf</span>,boundary<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">basins</span>,main<span class="op">=</span><span class="st">'basins'</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesoclim_3_spdscale_files/figure-html/calc_basins-1.png" width="700"></p>
<p>For the chosen study area, cold air drainage has no effect on local
temperatures during the chosen timeperiod (May):</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate using tmin to illustrate</span></span>
<span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">temp</span><span class="op">&lt;-</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tmin</span></span>
<span><span class="va">tcad</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/dot-tempcad.html">.tempcad</a></span><span class="op">(</span><span class="va">ukcp18rcm</span>,<span class="va">dtmf</span>,<span class="va">basins</span>,refhgt<span class="op">=</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tempheight_m</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tcad</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'temp_cad'</span>,<span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">tcad</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">tcad</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tme</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_q_layers.html">plot_q_layers</a></span><span class="op">(</span><span class="va">tcad</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesoclim_3_spdscale_files/figure-html/calc_cad-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="temperature-elevation-downscaling">Temperature elevation downscaling<a class="anchor" aria-label="anchor" href="#temperature-elevation-downscaling"></a>
</h4>
<p>Variable lapse rates derived from temperature, humidity and pressure
are applied to correct for elevation effects when downscaling. For daily
temperatures this can be carried out for min and max daily values.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tminelev</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/dot-tempelev.html">.tempelev</a></span><span class="op">(</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tmin</span>,<span class="va">dtmf</span>,<span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">dtm</span>,<span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">relhum</span>,<span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">pres</span><span class="op">)</span></span>
<span><span class="va">tmaxelev</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/dot-tempelev.html">.tempelev</a></span><span class="op">(</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tmax</span>,<span class="va">dtmf</span>,<span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">dtm</span>,<span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">relhum</span>,<span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">pres</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tminelev</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'tmin_elev'</span>,<span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">tminelev</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">tminelev</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tme</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tmaxelev</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'tmax_elev'</span>,<span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">tmaxelev</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">tmaxelev</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tme</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_q_layers.html">plot_q_layers</a></span><span class="op">(</span><span class="va">tminelev</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesoclim_3_spdscale_files/figure-html/temp_elev_dscale-1.png" width="700"></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_q_layers.html">plot_q_layers</a></span><span class="op">(</span><span class="va">tmaxelev</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesoclim_3_spdscale_files/figure-html/temp_elev_dscale-2.png" width="700"></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Check dirunal range of elev downscaling</span></span>
<span><span class="va">diurnaltmp</span><span class="op">&lt;-</span><span class="va">tmaxelev</span><span class="op">-</span><span class="va">tminelev</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">diurnaltmp</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'diurnal_t_range'</span>,<span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">diurnaltmp</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_q_layers.html">plot_q_layers</a></span><span class="op">(</span><span class="va">diurnaltmp</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesoclim_3_spdscale_files/figure-html/temp_elev_dscale-3.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="wind">Wind<a class="anchor" aria-label="anchor" href="#wind"></a>
</h4>
<p>Windspeed downscaling aims to capture the effect of both elevation
and the sheltering effects of topography that are in turn dependent on
wind direction and height above ground.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">windspeed</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/winddownscale.html">winddownscale</a></span><span class="op">(</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">windspeed</span>, <span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">winddir</span>, <span class="va">dtmf</span>, <span class="va">dtmm</span>, <span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">dtm</span>, zi <span class="op">=</span> <span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">windheight_m</span>, zo<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">windspeed</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'windspeed'</span>,<span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">windspeed</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">windspeed</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tme</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_q_layers.html">plot_q_layers</a></span><span class="op">(</span><span class="va">windspeed</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesoclim_3_spdscale_files/figure-html/wind_dscale-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="coastal-effects">Coastal effects<a class="anchor" aria-label="anchor" href="#coastal-effects"></a>
</h4>
<p>Uses sea surface temperatures, DTMs where sea is indicated by NA
values and downscaled windspeed to estimate the effect of coastal
effects. Coarse, medium and fine resolution DTMs are used to determine
effects of upwind sea areas.</p>
<p><em>ADD:</em> Guidance on selection of the extent of dtmm - how far
should dtms extend from the downscaling area to adequately capture
coastal effects??</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Interpolate - filling NAs and ensuring timesteps match climate inputs - MOVE THIS TO DATA PREP FUNCTION FOR SST??</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/global.html" class="external-link">global</a></span><span class="op">(</span><span class="va">sst</span>,<span class="va">anyNA</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="va">sstinterp</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/dot-spatinterp.html">.spatinterp</a></span><span class="op">(</span><span class="va">sst</span><span class="op">)</span> <span class="kw">else</span> <span class="va">sstinterp</span><span class="op">&lt;-</span><span class="va">sst</span></span>
<span><span class="va">sstinterp</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/dot-tmeinterp.html">.tmeinterp</a></span><span class="op">(</span><span class="va">sstinterp</span>,<span class="cn">NA</span>,<span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tme</span><span class="op">)</span></span>
<span><span class="co"># Resample to dtmf</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">sstinterp</span><span class="op">)</span> <span class="op">!=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">dtmf</span><span class="op">)</span><span class="op">)</span> <span class="va">sstinterp</span><span class="op">&lt;-</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/project.html" class="external-link">project</a></span><span class="op">(</span><span class="va">sstinterp</span>,<span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">dtmf</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sstf</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/dot-resample.html">.resample</a></span><span class="op">(</span><span class="va">sstinterp</span>,<span class="va">dtmf</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate coastal temp effects - uses already downscaled windspeed</span></span>
<span><span class="va">tmincoast</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/dot-tempcoastal.html">.tempcoastal</a></span><span class="op">(</span><span class="va">tminelev</span>,<span class="va">sstf</span>,<span class="va">windspeed</span>,<span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">winddir</span>,<span class="va">dtmf</span>,<span class="va">dtmm</span>,<span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">dtm</span><span class="op">)</span></span>
<span><span class="va">tmaxcoast</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/dot-tempcoastal.html">.tempcoastal</a></span><span class="op">(</span><span class="va">tmaxelev</span>,<span class="va">sstf</span>,<span class="va">windspeed</span>,<span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">winddir</span>,<span class="va">dtmf</span>,<span class="va">dtmm</span>,<span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">dtm</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tmincoast</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'tmin_coastef'</span>,<span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">tmincoast</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">tmincoast</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tme</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tmaxcoast</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'tmax_coastef'</span>,<span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">tmaxcoast</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">tmaxcoast</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tme</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_q_layers.html">plot_q_layers</a></span><span class="op">(</span><span class="va">tmincoast</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesoclim_3_spdscale_files/figure-html/coastal-1.png" width="700"></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_q_layers.html">plot_q_layers</a></span><span class="op">(</span><span class="va">tmaxcoast</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesoclim_3_spdscale_files/figure-html/coastal-2.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="all-temperature-effects-downscaling">All temperature effects downscaling<a class="anchor" aria-label="anchor" href="#all-temperature-effects-downscaling"></a>
</h4>
<p>If only concerned with temperature downscaling, the wrapper function
<code>tempdownscale</code> allows all relevant processes to be run as a
single function.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmin</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/tempdownscale.html">tempdownscale</a></span><span class="op">(</span> <span class="va">ukcp18rcm</span>,</span>
<span>                  <span class="va">sst</span>,<span class="co"># can be coarse resolution</span></span>
<span>                  <span class="va">dtmf</span>, <span class="co"># fine scale dem</span></span>
<span>                  <span class="va">dtmm</span> , <span class="co"># medium re wider are dem</span></span>
<span>                  basins <span class="op">=</span> <span class="va">basins</span>, <span class="co"># basindelin() output or will calculate</span></span>
<span>                  u2 <span class="op">=</span> <span class="va">windspeed</span>, <span class="co"># windspeeds downscaled - or will calculate</span></span>
<span>                  cad <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                  coastal <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                  tempvar <span class="op">=</span> <span class="st">'tmin'</span>,</span>
<span>                  whgto <span class="op">=</span> <span class="fl">2</span>, <span class="co"># output wind height above ground</span></span>
<span>                  thgto <span class="op">=</span> <span class="fl">2</span> <span class="co"># output temperature height above ground</span></span>
<span>                  <span class="op">)</span></span>
<span></span>
<span><span class="va">tmax</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/tempdownscale.html">tempdownscale</a></span><span class="op">(</span><span class="va">ukcp18rcm</span>,</span>
<span>                  <span class="va">sst</span>,<span class="co"># can be coarse</span></span>
<span>                  <span class="va">dtmf</span>, <span class="co"># fine scale dem</span></span>
<span>                  <span class="va">dtmm</span> , <span class="co"># medium re wider are dem</span></span>
<span>                  basins <span class="op">=</span> <span class="va">basins</span>, <span class="co"># basindelin() output</span></span>
<span>                  u2 <span class="op">=</span> <span class="va">windspeed</span>, <span class="co">#Â windspeeds downscaled</span></span>
<span>                  cad <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                  coastal <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                  tempvar <span class="op">=</span> <span class="st">'tmax'</span>,</span>
<span>                  whgto <span class="op">=</span> <span class="fl">2</span>, <span class="co"># output wind height above ground</span></span>
<span>                  thgto <span class="op">=</span> <span class="fl">2</span> <span class="co"># output temperature height above ground</span></span>
<span>                  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_q_layers.html">plot_q_layers</a></span><span class="op">(</span><span class="va">tmin</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesoclim_3_spdscale_files/figure-html/temp-dscale-1.png" width="700"></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_q_layers.html">plot_q_layers</a></span><span class="op">(</span><span class="va">tmax</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesoclim_3_spdscale_files/figure-html/temp-dscale-2.png" width="700"></p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">diurnaltmp</span><span class="op">&lt;-</span><span class="va">tmax</span><span class="op">-</span><span class="va">tmin</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">diurnaltmp</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'Diurnal_temp_range'</span>,<span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">diurnaltmp</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_q_layers.html">plot_q_layers</a></span><span class="op">(</span><span class="va">diurnaltmp</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesoclim_3_spdscale_files/figure-html/temp-dscale-3.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="precipitation">Precipitation<a class="anchor" aria-label="anchor" href="#precipitation"></a>
</h4>
<p>The <code><a href="../reference/precipdownscale.html">precipdownscale()</a></code> function provides various options
and methods to downscale rainfall.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">method</span><span class="op">&lt;-</span><span class="st">'Elev'</span></span>
<span><span class="va">precelev</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/precipdownscale.html">precipdownscale</a></span><span class="op">(</span></span>
<span>  <span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">prec</span>,</span>
<span>  <span class="va">dtmf</span>,</span>
<span>  <span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">dtm</span>,</span>
<span>  method <span class="op">=</span> <span class="va">method</span>,</span>
<span>  fast <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  noraincut <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>  patchsim <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  nsim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span> <span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">prec</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">precelev</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'prec_elev'</span>,<span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">precelev</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">precelev</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tme</span></span>
<span><span class="fu"><a href="../reference/plot_q_layers.html">plot_q_layers</a></span><span class="op">(</span><span class="va">precelev</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesoclim_3_spdscale_files/figure-html/precip-dscale-1.png" width="700"></p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">method</span><span class="op">&lt;-</span><span class="st">'Tps'</span></span>
<span><span class="va">prectps</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/precipdownscale.html">precipdownscale</a></span><span class="op">(</span></span>
<span>  <span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">prec</span>,</span>
<span>  <span class="va">dtmf</span>,</span>
<span>  <span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">dtm</span>,</span>
<span>  method <span class="op">=</span> <span class="va">method</span>,</span>
<span>  fast <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  noraincut <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>  patchsim <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  nsim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span> <span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">prec</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in precipdownscale(ukcp18rcm$prec, dtmf, ukcp18rcm$dtm, method =</span></span>
<span><span class="co">#&gt; method, : Not enough non NA cells for sensible thin-plate spline downscale.</span></span>
<span><span class="co">#&gt; Changed method to Elev</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">prectps</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'prec_tps'</span>,<span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">prectps</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">prectps</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tme</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_q_layers.html">plot_q_layers</a></span><span class="op">(</span><span class="va">prectps</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesoclim_3_spdscale_files/figure-html/precip-dscale-2.png" width="700"></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">prec</span><span class="op">&lt;-</span><span class="va">prectps</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="longwave-radiation-downscale">Longwave radiation downscale<a class="anchor" aria-label="anchor" href="#longwave-radiation-downscale"></a>
</h4>
<p>Longwave downscaling accounts for the effects of terrain shading
effect on skyview.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># simple downscaling</span></span>
<span><span class="va">lwf</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/dot-resample.html">.resample</a></span><span class="op">(</span><span class="fu"><a href="../reference/dot-rast.html">.rast</a></span><span class="op">(</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">lwrad</span>,<span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">dtm</span><span class="op">)</span>, <span class="va">dtmf</span>, msk<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># corrected for skyview  </span></span>
<span><span class="va">svf</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/dot-rta.html">.rta</a></span><span class="op">(</span><span class="fu">.skyview</span><span class="op">(</span><span class="va">dtmf</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">lwf</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">lwrad</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/dot-rast.html">.rast</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/coerce.html" class="external-link">as.array</a></span><span class="op">(</span><span class="va">lwf</span><span class="op">)</span><span class="op">*</span><span class="va">svf</span>,<span class="va">dtmf</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">lwrad</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'lwrad'</span>,<span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">lwrad</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">lwrad</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tme</span></span>
<span><span class="fu"><a href="../reference/plot_q_layers.html">plot_q_layers</a></span><span class="op">(</span><span class="va">lwrad</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesoclim_3_spdscale_files/figure-html/lw-dscale-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="shortwave-radiation-downscale">Shortwave radiation downscale<a class="anchor" aria-label="anchor" href="#shortwave-radiation-downscale"></a>
</h4>
<p>Can be carried out without cloud patchiness or terrain shadingâ€¦</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">swrad</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/swraddownscale.html">swdownscale</a></span><span class="op">(</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">swrad</span>,<span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXlt</a></span><span class="op">(</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tme</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span>,<span class="va">dtmf</span>,<span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">dtm</span>,patchsim <span class="op">=</span> <span class="cn">FALSE</span>,terrainshade <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">swrad</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'swrad'</span>,<span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">swrad</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">swrad</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tme</span></span>
<span>                       </span>
<span><span class="fu"><a href="../reference/plot_q_layers.html">plot_q_layers</a></span><span class="op">(</span><span class="va">swrad</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesoclim_3_spdscale_files/figure-html/sw-dscale-1.png" width="700"></p>
<p>â€¦ or with cloud patchinessâ€¦</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">swradp</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/swraddownscale.html">swdownscale</a></span><span class="op">(</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">swrad</span>,<span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tme</span>,<span class="va">dtmf</span>,<span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">dtm</span>,patchsim <span class="op">=</span> <span class="cn">TRUE</span>,nsim<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tme</span><span class="op">)</span>,terrainshade <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">swradp</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'swrad_with_patchiness'</span>,<span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">swradp</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">swradp</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">ukcp18rcm</span><span class="op">$</span><span class="va">tme</span></span>
<span>                       </span>
<span><span class="fu"><a href="../reference/plot_q_layers.html">plot_q_layers</a></span><span class="op">(</span><span class="va">swradp</span><span class="op">)</span></span></code></pre></div>
<img src="mesoclim_3_spdscale_files/figure-html/sw-patchdscale-1.png" width="700"><div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;">

</div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ilya Maclean, Alexandra Gardner, Jonathan Mosedale.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
